<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma Inventários 2026 - Diamantes</title>
    
    <!-- Tailwind CSS (CDN Otimizado) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Otimizações de Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #991b1b; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #7f1d1d; }
        
        /* Animação de Fade para o Slide */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-slide {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Loading Spinner Styles */
        #initial-loader {
            position: fixed;
            inset: 0;
            background-color: #f9fafb;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #991b1b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
    </style>
</head>
<body>
    <!-- Tela de Carregamento Inicial (Aparece antes do React) -->
    <div id="initial-loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #991b1b; font-weight: bold; font-family: sans-serif;">Carregando Cronograma...</p>
    </div>

    <div id="root"></div>

    <!-- Script Principal -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Calendar as CalendarIcon, ChevronLeft, ChevronRight, Upload, Printer, Store, User, Search, 
            CheckCircle2, X, Car, Bus, Plane, Database, TrendingUp, History, Trash2, AlertTriangle, Route, MapPin, Check, Save 
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- DADOS E CONSTANTES ---
        const CITY_COORDS = {
            "FORTALEZA": { lat: -3.71722, lng: -38.5434 },
            "TERESINA": { lat: -5.09200, lng: -42.8038 },
            "NATAL": { lat: -5.79448, lng: -35.2110 },
            "JOAO PESSOA": { lat: -7.11949, lng: -34.8450 },
            "MACEIO": { lat: -9.66625, lng: -35.7351 },
            "ARACAJU": { lat: -10.9472, lng: -37.0731 },
            "SALVADOR": { lat: -12.9777, lng: -38.5016 },
            "SAO LUIS": { lat: -2.53073, lng: -44.3068 },
            "BELEM": { lat: -1.45575, lng: -48.4902 },
            "MOSSORO": { lat: -5.18625, lng: -37.3469 },
            "CAMPINA GRANDE": { lat: -7.22196, lng: -35.8845 },
            "PICOS": { lat: -7.07823, lng: -41.4707 },
            "IMPERATRIZ": { lat: -5.52655, lng: -47.4760 },
            "MARABA": { lat: -5.3686, lng: -49.1174 },
            "CARUARU": { lat: -8.28311, lng: -35.9754 },
            "FEIRA DE SANTANA": { lat: -12.2608, lng: -38.9626 },
            "PAULO AFONSO": { lat: -9.3986, lng: -38.2255 },
            "GARANHUNS": { lat: -8.8824, lng: -36.4965 },
            "ARAPIRACA": { lat: -9.7562, lng: -36.6606 },
            "ITABAIANA": { lat: -10.6853, lng: -37.4267 },
            "BACABAL": { lat: -4.2238, lng: -44.7869 },
            "CASTANHAL": { lat: -1.2965, lng: -47.9254 },
            "PEDREIRAS": { lat: -4.5684, lng: -44.5982 },
            "SANTA INES": { lat: -3.6664, lng: -45.3804 },
            "PINHEIRO": { lat: -2.5186, lng: -45.0805 },
            "PRESIDENTE DUTRA": { lat: -5.2891, lng: -44.4905 },
            "PARAUAPEBAS": { lat: -6.0674, lng: -49.9023 },
            "ACAILANDIA": { lat: -4.9452, lng: -47.4984 },
            "SANTA RITA": { lat: -7.1122, lng: -34.9753 },
            "PARNAIBA": { lat: -2.9095, lng: -41.7766 },
            "ALAGOINHAS": { lat: -12.1356, lng: -38.4284 },
            "BRASILIA": { lat: -15.7975, lng: -47.8919 },
            "FRECHEIRINHA": { lat: -3.7553, lng: -40.8178 }, 
            "VILA UNIAO": { lat: -3.7553, lng: -38.5375 },
            "MARAPONGA": { lat: -3.7925, lng: -38.5670 },
            "PARNAMIRIM": { lat: -5.9157, lng: -35.2635 },
        };

        const NAME_ALIASES = {
            "F. DE SANTANA": "FEIRA DE SANTANA 1",
            "CAMP. GRANDE": "CAMPINA GRANDE",
            "VILA UNIAO": "VILA UNIAO", 
            "ARACAJU 01": "ARACAJU 1",
            "ARACAJU 03": "ARACAJU 3",
            "JOAO PESSOA 04": "JOAO PESSOA 4",
            "JOAO PESSOA 03": "JOAO PESSOA 3",
            "LOJA CETRO": "DIAMANTES CENTRO",
            "LOJA BR": "BR",
            "TELEDIGITAL": "TELEDIGITAL",
            "MACEIO 02": "MACEIO 2",
            "MACEIO 03": "MACEIO 3",
            "SAO LUIS 01": "SAO LUIS 1",
            "MARAPONGA": "MARAPONGA",
            "ARAPIRACA 02": "ARAPIRACA 2",
            "ARAPIRACA 01": "ARAPIRACA 1",
        };

        const HOLIDAYS_2026 = [
            { date: '2026-01-01', name: 'Confraternização Universal', type: 'Nacional' },
            { date: '2026-02-17', name: 'Carnaval', type: 'Nacional' },
            { date: '2026-03-06', name: 'Data Magna (PE)', type: 'Estadual (PE)' },
            { date: '2026-03-25', name: 'Data Magna (CE)', type: 'Estadual (CE)' },
            { date: '2026-04-03', name: 'Sexta-feira Santa', type: 'Nacional' },
            { date: '2026-04-21', name: 'Tiradentes / Fundação BSB', type: 'Nacional/DF' },
            { date: '2026-05-01', name: 'Dia do Trabalho', type: 'Nacional' },
            { date: '2026-06-04', name: 'Corpus Christi', type: 'Nacional' },
            { date: '2026-07-02', name: 'Independência da Bahia', type: 'Estadual (BA)' },
            { date: '2026-07-08', name: 'Emancipação de Sergipe', type: 'Estadual (SE)' },
            { date: '2026-07-28', name: 'Adesão à Independência', type: 'Estadual (MA)' },
            { date: '2026-08-05', name: 'Fundação do Estado', type: 'Estadual (PB)' },
            { date: '2026-08-15', name: 'Adesão à Independência', type: 'Estadual (PA)' },
            { date: '2026-09-07', name: 'Independência do Brasil', type: 'Nacional' },
            { date: '2026-09-16', name: 'Emancipação Política', type: 'Estadual (AL)' },
            { date: '2026-10-03', name: 'Mártires Cunhaú/Uruaçu', type: 'Estadual (RN)' },
            { date: '2026-10-12', name: 'Nossa Sra. Aparecida', type: 'Nacional' },
            { date: '2026-10-19', name: 'Dia do Piauí', type: 'Estadual (PI)' },
            { date: '2026-11-02', name: 'Finados', type: 'Nacional' },
            { date: '2026-11-15', name: 'Proclamação da República', type: 'Nacional' },
            { date: '2026-12-25', name: 'Natal', type: 'Nacional' }
        ];

        const INITIAL_RAW_DATA = `
JULIETA MATOS
LOJA TERESINA 5
LOJA JOAO PESSOA 1
LOJA PICOS
LOJA JOAO PESSOA 2
LOJA SANTA RITA
LOJA TERESINA 4
LOJA CAMPINA GRANDE
LOJA NATAL 3
LOJA FORTALEZA 1
LOJA NATAL 1
LOJA TERESINA 3
LOJA BR
LOJA JOAO PESSOA 4
LOJA PARNAMIRIM
LOJA JOAO PESSOA 3
LOJA MOSSORO
LOJA PATOS
LOJA FORTALEZA 5
LOJA PARNAIBA
LOJA DIAMANTES CENTRO
LOJA TELEDIGITAL
LOJA MARAPONGA
LOJA VILA UNIAO

ELITIANE GOMES
LOJA ACAILANDIA
LOJA BELEM 1
LOJA BELEM 2
LOJA PARAUAPEBAS
LOJA SAO LUIS 4
LOJA PRESIDENTE DUTRA
LOJA PINHEIRO
LOJA BACABAL 1
LOJA CASTANHAL
LOJA PEDREIRAS
LOJA SANTA INES
LOJA MARABA
LOJA SAO LUIS 3
LOJA SAO LUIS 2
LOJA IMPERATRIZ
LOJA SAO LUIS 1

LUCIANA OLIVEIRA
LOJA BRASILIA
LOJA FEIRA DE SANTANA 1
LOJA CARUARU
LOJA GARANHUNS
LOJA PAULO AFONSO 1
LOJA ARACAJU 3
LOJA MACEIO 2
LOJA ARACAJU 1
LOJA MACEIO 3
LOJA ALAGOINHAS
LOJA ARAPIRACA 1
LOJA ARAPIRACA 2
LOJA ITABAIANA
`;

        const INITIAL_STATS_CSV = `
LL,CICLO,LOJAS,ACURACIDADE
2022,1,Patos,0.9930
2025,1,Aracaju 3,0.8683
2025,1,Fortaleza 1 (44),0.9850
2025,1,João Pessoa 4,
2025,1,Campina Grande,0.9500
2025,1,Mossoro,0.9720
2025,1,Natal 1,0.9910
`;

        const INITIAL_SCHEDULE_CSV = `
Data,Loja,Coordenadora,Transporte,Status
2026-01-13,LOJA GARANHUNS,LUCIANA OLIVEIRA,Carro,CONCLUIDO
2026-01-14,LOJA CARUARU,LUCIANA OLIVEIRA,Carro,CONCLUIDO
2026-03-03,LOJA BR,JULIETA MATOS,Carro,PENDENTE
2026-03-03,LOJA ARACAJU 1,LUCIANA OLIVEIRA,Avião,PENDENTE
2026-03-04,LOJA DIAMANTES CENTRO,JULIETA MATOS,Carro,PENDENTE
2026-03-05,LOJA TELEDIGITAL,JULIETA MATOS,Carro,PENDENTE
2026-03-10,LOJA PATOS,JULIETA MATOS,Carro,PENDENTE
2026-03-11,LOJA PAULO AFONSO 1,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-03-12,LOJA ALAGOINHAS,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-03-13,LOJA FEIRA DE SANTANA 1,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-04-02,LOJA BRASILIA,LUCIANA OLIVEIRA,Avião,PENDENTE
2026-04-06,LOJA IMPERATRIZ,ELITIANE GOMES,Carro,PENDENTE
2026-04-07,LOJA ACAILANDIA,ELITIANE GOMES,Carro,PENDENTE
2026-04-08,LOJA MARABA,ELITIANE GOMES,Carro,PENDENTE
2026-04-09,LOJA PARAUAPEBAS,ELITIANE GOMES,Carro,PENDENTE
2026-05-04,LOJA JOAO PESSOA 1,JULIETA MATOS,Carro,PENDENTE
2026-05-05,LOJA JOAO PESSOA 2,JULIETA MATOS,Carro,PENDENTE
2026-05-06,LOJA JOAO PESSOA 3,JULIETA MATOS,Carro,PENDENTE
2026-05-07,LOJA JOAO PESSOA 4,JULIETA MATOS,Carro,PENDENTE
2026-05-11,LOJA MACEIO 2,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-05-12,LOJA MACEIO 3,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-05-13,LOJA ARAPIRACA 1,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-05-14,LOJA ARAPIRACA 2,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-06-08,LOJA PICOS,JULIETA MATOS,Carro,PENDENTE
2026-06-09,LOJA TERESINA 3,JULIETA MATOS,Carro,PENDENTE
2026-06-10,LOJA TERESINA 4,JULIETA MATOS,Carro,PENDENTE
2026-06-11,LOJA TERESINA 5,JULIETA MATOS,Carro,PENDENTE
2026-06-12,LOJA PARNAIBA,JULIETA MATOS,Carro,PENDENTE
2026-06-15,LOJA VILA UNIAO,JULIETA MATOS,Carro,PENDENTE
2026-06-16,LOJA MARAPONGA,JULIETA MATOS,Carro,PENDENTE
2026-06-18,LOJA ARACAJU 3,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-06-19,LOJA ITABAIANA,LUCIANA OLIVEIRA,Carro,PENDENTE
2026-08-10,LOJA PINHEIRO,ELITIANE GOMES,Carro,PENDENTE
2026-08-11,LOJA SAO LUIS 1,ELITIANE GOMES,Carro,PENDENTE
2026-08-12,LOJA SAO LUIS 2,ELITIANE GOMES,Carro,PENDENTE
2026-08-13,LOJA SAO LUIS 3,ELITIANE GOMES,Carro,PENDENTE
2026-08-14,LOJA SAO LUIS 4,ELITIANE GOMES,Carro,PENDENTE
2026-08-18,LOJA PRESIDENTE DUTRA,ELITIANE GOMES,Carro,PENDENTE
2026-08-19,LOJA PEDREIRAS,ELITIANE GOMES,Carro,PENDENTE
2026-08-20,LOJA BACABAL 1,ELITIANE GOMES,Carro,PENDENTE
2026-08-21,LOJA SANTA INES,ELITIANE GOMES,Carro,PENDENTE
2026-09-01,LOJA BELEM 1,ELITIANE GOMES,Avião,PENDENTE
2026-09-02,LOJA BELEM 2,ELITIANE GOMES,Avião,PENDENTE
2026-09-03,LOJA CASTANHAL,ELITIANE GOMES,Carro,PENDENTE
2026-09-14,LOJA MOSSORO,JULIETA MATOS,Carro,PENDENTE
2026-09-15,LOJA NATAL 3,JULIETA MATOS,Carro,PENDENTE
2026-09-16,LOJA NATAL 1,JULIETA MATOS,Carro,PENDENTE
2026-09-17,LOJA SANTA RITA,JULIETA MATOS,Carro,PENDENTE
2026-09-18,LOJA PARNAMIRIM,JULIETA MATOS,Carro,PENDENTE
2026-09-19,LOJA CAMPINA GRANDE,JULIETA MATOS,Carro,PENDENTE
`;

        // --- FUNÇÕES UTILITÁRIAS ---
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
            return R * c;
        };

        const normalizeName = (name) => {
            let clean = name.toUpperCase().replace('LOJA ', '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            if (NAME_ALIASES[clean]) { clean = NAME_ALIASES[clean]; }
            return clean.replace(/0+(\d+)/, '$1').replace(/\s+\(\d+\)$/, '').trim();
        };

        const inferCityFromName = (name) => {
            let clean = name.toUpperCase().replace('LOJA ', '').trim();
            clean = clean.replace(/\s+\d+$/, '');
            if (clean === "BR") return "FRECHEIRINHA";
            if (clean === "DIAMANTES CENTRO") return "FORTALEZA";
            return clean;
        };

        const parseStoreList = (text) => {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const stores = [];
            let currentCoordinator = "Sem Coordenador";
            lines.forEach((line) => {
                if (line.toUpperCase() === 'LOJA' || line.length < 3) return;
                if (line.toUpperCase().startsWith('LOJA ')) {
                    stores.push({
                        id: Math.random().toString(36).substr(2, 9),
                        name: line,
                        coordinator: currentCoordinator,
                        city: inferCityFromName(line)
                    });
                } else {
                    currentCoordinator = line;
                }
            });
            return stores;
        };

        const parseIndicators = (csvText) => {
            const statsMap = {};
            const lines = csvText.split(/\r?\n/);
            let delimiter = ',';
            const sample = lines.slice(0, 10).join('\n');
            if ((sample.match(/;/g) || []).length > (sample.match(/,/g) || []).length) delimiter = ';';
            
            let startRowIndex = -1;
            let idxLL = 0, idxCiclo = 1, idxLojas = 2, idxAcc = 15;

            for (let i = 0; i < Math.min(lines.length, 20); i++) {
                const lineUpper = lines[i].toUpperCase();
                if (lineUpper.includes('LL') && (lineUpper.includes('CICLO') || lineUpper.includes('LOJAS'))) {
                    startRowIndex = i + 1;
                    const headers = lines[i].split(delimiter).map(h => h.trim().toUpperCase());
                    const findLL = headers.indexOf('LL');
                    const findCiclo = headers.indexOf('CICLO');
                    const findLojas = headers.findIndex(h => h === 'LOJAS' || h === 'LOJA');
                    const findAcc = headers.findIndex(h => h.includes('ACURACIDADE'));

                    if (findLL > -1) idxLL = findLL;
                    if (findCiclo > -1) idxCiclo = findCiclo;
                    if (findLojas > -1) idxLojas = findLojas;
                    if (findAcc > -1) idxAcc = findAcc;
                    break;
                }
            }

            if (startRowIndex === -1) startRowIndex = 1;
            const tracking = {};

            for (let i = startRowIndex; i < lines.length; i++) {
                const row = lines[i].split(delimiter);
                if (row.length <= Math.max(idxLojas, idxAcc) && idxAcc !== 15) continue; 
                const rawName = row[idxLojas];
                if (!rawName || rawName.trim() === '') continue;
                
                const nameKey = normalizeName(rawName);
                const year = parseInt(row[idxLL]) || 0;
                const cycle = parseInt(row[idxCiclo]) || 0;
                const rawAcc = row[idxAcc] || "";
                
                const currentTrack = tracking[nameKey] || { y: -1, c: -1 };
                
                if (year > currentTrack.y || (year === currentTrack.y && cycle > currentTrack.c)) {
                    tracking[nameKey] = { y: year, c: cycle };
                    let accDisplay = rawAcc;
                    try {
                        const normalizedNum = rawAcc.replace(',', '.');
                        const val = parseFloat(normalizedNum);
                        if (!isNaN(val)) {
                            const percentage = val <= 1.05 ? val * 100 : val;
                            accDisplay = percentage.toFixed(2) + '%';
                        }
                    } catch (e) {}
                    statsMap[nameKey] = { lastBalance: `Ciclo ${cycle}/${year}`, accuracy: accDisplay };
                }
            }
            return statsMap;
        };

        const parseScheduleCSV = (csvText, stores) => {
            const assignments = [];
            const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
            const startIdx = lines[0].toLowerCase().startsWith("data") ? 1 : 0;

            for (let i = startIdx; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < 2) continue;
                const dateStr = row[0].trim();
                const rawStoreName = row[1].trim();
                const rawTransport = row[3]?.trim().toLowerCase();
                const rawStatus = row[4]?.trim().toUpperCase();
                const normalizedCalName = normalizeName(rawStoreName);
                const match = stores.find(s => normalizeName(s.name) === normalizedCalName);

                if (match) {
                    let transport = 'car';
                    if (rawTransport && (rawTransport.includes('avi') || rawTransport.includes('plane'))) transport = 'plane';
                    else if (rawTransport && (rawTransport.includes('bus') || rawTransport.includes('oni'))) transport = 'bus';
                    const isCompleted = rawStatus === 'CONCLUIDO' || rawStatus === 'REALIZADO' || rawStatus === 'CONCLUÍDO';
                    assignments.push({ storeId: match.id, dateStr: dateStr, transport: transport, completed: isCompleted });
                }
            }
            return assignments;
        };

        const formatDate = (year, month, day) => {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        };

        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        const getTransportIcon = (type, size = 12) => {
            switch (type) {
                case 'bus': return <Bus size={size} />;
                case 'plane': return <Plane size={size} />;
                case 'car': default: return <Car size={size} />;
            }
        };

        const getTransportLabel = (type) => {
            switch (type) {
                case 'bus': return 'Ônibus';
                case 'plane': return 'Avião';
                case 'car': default: return 'Carro';
            }
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [stores, setStores] = useState([]);
            const [stats, setStats] = useState({});
            const [assignments, setAssignments] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1)); 
            const [selectedStoreId, setSelectedStoreId] = useState(null);
            const [selectedTransport, setSelectedTransport] = useState('car');
            const [searchTerm, setSearchTerm] = useState('');
            const [hoveredStoreId, setHoveredStoreId] = useState(null);
            const [pdfReady, setPdfReady] = useState(false);
            const [currentTickerIndex, setCurrentTickerIndex] = useState(0);
            const storeRefs = useRef({});

            // Remover a tela de carregamento quando o React montar
            useEffect(() => {
                const loader = document.getElementById('initial-loader');
                if (loader) {
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        loader.style.visibility = 'hidden';
                    }, 800); 
                }
            }, []);

            useEffect(() => {
                const checkJsPDF = () => {
                    if (window.jspdf && window.jspdf.jsPDF) {
                        window.jsPDF = window.jspdf.jsPDF;
                        setPdfReady(true);
                    }
                };
                checkJsPDF();
                window.onload = checkJsPDF;
            }, []);
            
            useEffect(() => {
                const loadedStores = parseStoreList(INITIAL_RAW_DATA);
                setStores(loadedStores);
                const loadedStats = parseIndicators(INITIAL_STATS_CSV);
                setStats(loadedStats);
                const defaultAssignments = parseScheduleCSV(INITIAL_SCHEDULE_CSV, loadedStores);

                const savedAssign = localStorage.getItem('diamantes_inventory_assignments_v14');
                if (savedAssign) {
                    const parsed = JSON.parse(savedAssign);
                    if (parsed.length > 0) {
                        const merged = [...parsed];
                        defaultAssignments.forEach(def => {
                            if (!merged.some(m => m.storeId === def.storeId && m.dateStr === def.dateStr)) {
                                merged.push(def);
                            }
                        });
                        setAssignments(merged);
                    } else {
                        setAssignments(defaultAssignments);
                    }
                } else {
                    setAssignments(defaultAssignments);
                }

                const savedStats = localStorage.getItem('diamantes_inventory_stats');
                if (savedStats) {
                    setStats(prev => ({ ...prev, ...JSON.parse(savedStats) }));
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('diamantes_inventory_assignments_v14', JSON.stringify(assignments));
            }, [assignments]);

            useEffect(() => {
                localStorage.setItem('diamantes_inventory_stats', JSON.stringify(stats));
            }, [stats]);

            useEffect(() => {
                if (selectedStoreId && storeRefs.current[selectedStoreId]) {
                    storeRefs.current[selectedStoreId]?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, [selectedStoreId]);

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            
            const monthNames = [ "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro" ];

            const getStoreStatus = (id) => {
                const assign = assignments.find(a => a.storeId === id);
                return assign ? { scheduled: true, date: assign.dateStr } : { scheduled: false, date: null };
            };

            const filteredStores = useMemo(() => {
                return stores.map(store => {
                    const key = normalizeName(store.name);
                    const storeStat = stats[key];
                    return { ...store, stats: storeStat };
                }).filter(store => {
                    const search = searchTerm.toLowerCase();
                    const matchesSearch = store.name.toLowerCase().includes(search) || 
                                          store.coordinator.toLowerCase().includes(search);
                    return matchesSearch;
                });
            }, [stores, stats, searchTerm]);

            const nearbyStores = useMemo(() => {
                if (!selectedStoreId) return [];
                const selectedStore = stores.find(s => s.id === selectedStoreId);
                if (!selectedStore || !selectedStore.city) return [];
                const originCoords = CITY_COORDS[selectedStore.city];
                if (!originCoords) return []; 
                return stores
                    .filter(s => s.id !== selectedStoreId && s.city && CITY_COORDS[s.city]) 
                    .map(s => {
                        const targetCoords = CITY_COORDS[s.city];
                        const dist = calculateDistance(originCoords.lat, originCoords.lng, targetCoords.lat, targetCoords.lng);
                        return { ...s, distance: dist };
                    })
                    .filter(s => s.distance <= 400) 
                    .sort((a, b) => a.distance - b.distance); 
            }, [selectedStoreId, stores]);

            // --- Lógica do Novo Letreiro (Slide por Mês) ---
            const tickerGroups = useMemo(() => {
                const groups = {};
                assignments.forEach(a => {
                    const date = new Date(a.dateStr + 'T12:00:00');
                    const m = date.getMonth();
                    const y = date.getFullYear();
                    const key = `${y}-${m}`;
                    if (!groups[key]) groups[key] = { year: y, month: m, items: [] };
                    groups[key].items.push(a);
                });
                return Object.values(groups).sort((a,b) => (a.year - b.year) || (a.month - b.month));
            }, [assignments]);

            useEffect(() => {
                if (tickerGroups.length === 0) return;
                const interval = setInterval(() => {
                    setCurrentTickerIndex(prev => (prev + 1) % tickerGroups.length);
                }, 5000); // 5 segundos
                return () => clearInterval(interval);
            }, [tickerGroups.length]);

            const formatDayOnly = (dateStr) => {
                return dateStr.split('-')[2];
            };

            const handleDateClick = (day) => {
                const dateStr = formatDate(year, month, day);
                if (selectedStoreId) {
                    const newAssignments = assignments.filter(a => a.storeId !== selectedStoreId);
                    newAssignments.push({ storeId: selectedStoreId, dateStr, transport: selectedTransport, completed: false });
                    setAssignments(newAssignments);
                    setSelectedStoreId(null); 
                }
            };

            const removeAssignment = (storeId) => {
                setAssignments(assignments.filter(a => a.storeId !== storeId));
                if (selectedStoreId === storeId) setSelectedStoreId(null);
            };

            const toggleCompletion = (storeId) => {
                setAssignments(prev => prev.map(a => a.storeId === storeId ? { ...a, completed: !a.completed } : a));
            };

            const updateTransport = (storeId, type) => {
                setSelectedTransport(type);
                if (assignments.some(a => a.storeId === storeId)) {
                    setAssignments(assignments.map(a => a.storeId === storeId ? { ...a, transport: type } : a));
                }
            };

            const exportCSV = () => {
                const headers = ["Data", "Loja", "Coordenadora", "Transporte", "Status", "Ultimo Balanco", "Acuracidade"];
                const rows = assignments.map(a => {
                    const store = filteredStores.find(s => s.id === a.storeId);
                    return [
                        a.dateStr,
                        store?.name || "Loja Desconhecida",
                        store?.coordinator || "-",
                        getTransportLabel(a.transport || 'car'),
                        a.completed ? "CONCLUIDO" : "PENDENTE",
                        store?.stats?.lastBalance || "-",
                        store?.stats?.accuracy || "-"
                    ].join(",");
                });
                filteredStores.filter(s => !assignments.find(a => a.storeId === s.id)).forEach(s => {
                    rows.push(`Não Agendado,${s.name},${s.coordinator},-,PENDENTE,${s.stats?.lastBalance || "-"},${s.stats?.accuracy || "-"}`);
                });
                const blob = new Blob(["\uFEFF" + headers.join(",") + "\n" + rows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "cronograma_inventario_diamantes.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- NOVA FUNÇÃO DE EXPORTAÇÃO PDF COM TABELA E CALENDÁRIO VISUAL ---
            const handleExportPDF = () => {
                if (!pdfReady || !window.jsPDF) { alert("Aguarde, carregando biblioteca de PDF..."); return; }
                try {
                    const doc = new window.jsPDF();

                    // =========================================================
                    // PÁGINA 1: TABELA DE CRONOGRAMA DE INVENTÁRIOS
                    // =========================================================
                    doc.setFillColor(153, 27, 27); // Vermelho Escuro (#991b1b)
                    doc.rect(0, 0, 210, 20, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text("Cronograma anual de inventários / 2026", 14, 13);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Diamantes Lingerie", 160, 13);

                    const tableColumn = ["Data", "Loja", "Coordenadora", "Transporte", "Status"];
                    const tableRows = [];
                    const sortedAssignments = [...assignments].sort((a,b) => a.dateStr.localeCompare(b.dateStr));
                    let lastDate = null;

                    sortedAssignments.forEach(assign => {
                        const currentDate = new Date(assign.dateStr + 'T12:00:00');
                        if (lastDate) {
                            const diffDays = Math.ceil(Math.abs(currentDate.getTime() - lastDate.getTime()) / (1000 * 60 * 60 * 24));
                            if (diffDays > 3) {
                                tableRows.push([{ content: '', colSpan: 5, styles: { fillColor: [255, 255, 255], minCellHeight: 5 } }]);
                            }
                        }
                        const store = stores.find(s => s.id === assign.storeId);
                        tableRows.push([
                            assign.dateStr.split('-').reverse().join('/'),
                            store?.name.replace('LOJA ', '') || '',
                            store?.coordinator || '',
                            getTransportLabel(assign.transport),
                            assign.completed ? 'CONCLUÍDO' : 'PENDENTE'
                        ]);
                        lastDate = currentDate;
                    });

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 25,
                        theme: 'grid',
                        headStyles: { fillColor: [153, 27, 27], textColor: [255, 255, 255] },
                        styles: { fontSize: 8, cellPadding: 2, lineColor: [200, 200, 200] },
                        alternateRowStyles: { fillColor: [255, 241, 242] },
                    });

                    // =========================================================
                    // PÁGINAS SEGUINTES: CALENDÁRIO MENSAL VISUAL
                    // =========================================================
                    const monthGroups = {};
                    sortedAssignments.forEach(a => {
                        const date = new Date(a.dateStr + 'T12:00:00');
                        const y = date.getFullYear();
                        const m = date.getMonth();
                        const key = `${y}-${m}`;
                        
                        if (!monthGroups[key]) monthGroups[key] = { year: y, month: m, days: {} };
                        
                        const day = date.getDate();
                        if (!monthGroups[key].days[day]) monthGroups[key].days[day] = [];
                        monthGroups[key].days[day].push(a);
                    });

                    let sortedMonths = Object.values(monthGroups).sort((a,b) => a.year - b.year || a.month - b.month);
                    if (sortedMonths.length === 0) {
                        sortedMonths = [{ year: currentDate.getFullYear(), month: currentDate.getMonth(), days: {} }];
                    }

                    sortedMonths.forEach(group => {
                        doc.addPage(); 

                        doc.setFillColor(153, 27, 27);
                        doc.rect(0, 0, 210, 20, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(16);
                        doc.setFont("helvetica", "bold");
                        const monthTitle = `${monthNames[group.month]} ${group.year}`;
                        doc.text(monthTitle, 105, 13, { align: "center" });

                        const daysInMonthTotal = new Date(group.year, group.month + 1, 0).getDate();
                        const firstDayOfWeek = new Date(group.year, group.month, 1).getDay(); 
                        
                        const calRows = [];
                        let currentWeek = Array(7).fill({ content: '', styles: { fillColor: [250, 250, 250] } });
                        let currentDayPos = firstDayOfWeek;

                        for(let day = 1; day <= daysInMonthTotal; day++) {
                            let isAssigned = false;
                            let cellText = `${day}`; 

                            const dateStrPDF = `${group.year}-${String(group.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const pdfDayHolidays = HOLIDAYS_2026.filter(h => h.date === dateStrPDF);

                            if (pdfDayHolidays.length > 0) {
                                cellText += `\n\n[FERIADO]\n${pdfDayHolidays.map(h => h.name).join(' / ')}`;
                            }

                            if (group.days[day]) {
                                isAssigned = true;
                                group.days[day].forEach(assign => {
                                    const store = stores.find(s => s.id === assign.storeId);
                                    if(store) {
                                        const cleanStoreName = store.name.replace('LOJA ', '');
                                        const shortCoord = store.coordinator.split(' ')[0]; 
                                        cellText += `\n\n${cleanStoreName}\n(${shortCoord})`;
                                    }
                                });
                            }

                            let cellFillColor = [255, 255, 255];
                            if (isAssigned) {
                                cellFillColor = [254, 226, 226]; // Inventário: Fundo Vermelho Claro
                            } else if (pdfDayHolidays.length > 0) {
                                cellFillColor = [239, 246, 255]; // Feriado (sem inventário): Fundo Azul muito claro
                            }

                            currentWeek[currentDayPos] = {
                                content: cellText,
                                styles: { fillColor: cellFillColor }
                            };

                            currentDayPos++;
                            
                            if(currentDayPos > 6) {
                                calRows.push(currentWeek);
                                currentWeek = Array(7).fill({ content: '', styles: { fillColor: [250, 250, 250] } });
                                currentDayPos = 0;
                            }
                        }
                        
                        if(currentDayPos > 0) {
                            calRows.push(currentWeek);
                        }

                        doc.autoTable({
                            startY: 25,
                            head: [['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB']],
                            body: calRows,
                            theme: 'grid',
                            headStyles: { 
                                fillColor: [153, 27, 27], 
                                textColor: [255, 255, 255], 
                                halign: 'center', 
                                fontStyle: 'bold',
                                fontSize: 10
                            },
                            styles: { 
                                valign: 'top', 
                                halign: 'left', 
                                fontSize: 7, 
                                font: 'helvetica',
                                lineColor: [200, 200, 200], 
                                lineWidth: 0.2,
                                minCellHeight: 35, 
                                overflow: 'linebreak'
                            },
                            columnStyles: {
                                0: { cellWidth: 26 },
                                1: { cellWidth: 26 },
                                2: { cellWidth: 26 },
                                3: { cellWidth: 26 },
                                4: { cellWidth: 26 },
                                5: { cellWidth: 26 },
                                6: { cellWidth: 26 }
                            }
                        });
                    });

                    doc.save("cronograma_diamantes_2026.pdf");
                } catch (err) { console.error(err); alert("Erro ao gerar PDF."); }
            };

            const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

            return (
                <div className="h-screen bg-gray-50 flex flex-col font-sans text-slate-800 overflow-hidden">
                    <header className="bg-gradient-to-r from-red-900 to-red-800 text-white px-6 py-4 flex flex-col md:flex-row justify-between items-center shadow-lg z-10 shrink-0">
                        <div className="flex items-center gap-4 mb-4 md:mb-0">
                            <div className="bg-white/10 p-2.5 rounded-lg text-white backdrop-blur-sm border border-white/20 shadow-inner">
                                <Store size={28} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold leading-tight tracking-tight text-white drop-shadow-sm">Cronograma anual de inventários / 2026</h1>
                                <p className="text-xs font-medium text-red-100 uppercase tracking-widest opacity-90">Diamantes Lingerie</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="flex gap-3">
                                <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-red-800 text-white hover:bg-red-700 rounded-lg transition-all text-sm font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 border border-white/20">
                                    <Save size={18} /> Salvar
                                </button>
                                <button onClick={handleExportPDF} className="flex items-center gap-2 px-4 py-2 bg-white text-red-900 hover:bg-red-50 rounded-lg transition-all text-sm font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0">
                                    <Printer size={18} /> Exportar PDF
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                        <aside className="w-full md:w-[240px] bg-white border-r border-gray-200 flex flex-col h-full shrink-0 z-20 shadow-sm md:shadow-none">
                            <div className="p-4 border-b border-gray-100 space-y-4 bg-white shrink-0">
                                <div className="relative">
                                    <Search className="absolute left-4 top-3.5 text-gray-400" size={20} />
                                    <input 
                                        type="text" 
                                        placeholder="Buscar loja ou coordenadora..." 
                                        className="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-red-800" 
                                        value={searchTerm} 
                                        onChange={(e) => setSearchTerm(e.target.value)} 
                                    />
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                <h3 className="text-sm font-bold text-gray-500 uppercase px-1 mb-3">Lojas Disponíveis</h3>
                                {filteredStores.map(store => {
                                    const status = getStoreStatus(store.id);
                                    const isSelected = selectedStoreId === store.id;
                                    const isHovered = hoveredStoreId === store.id;
                                    return (
                                        <div key={store.id} ref={el => storeRefs.current[store.id] = el}
                                            onMouseEnter={() => setHoveredStoreId(store.id)} onMouseLeave={() => setHoveredStoreId(null)}
                                            onClick={() => {
                                                if (isSelected) { setSelectedStoreId(null); } 
                                                else { setSelectedStoreId(store.id); if (status.scheduled) { const assign = assignments.find(a => a.storeId === store.id); if (assign) setSelectedTransport(assign.transport); } else { setSelectedTransport('car'); } }
                                            }}
                                            className={`group p-3 rounded-xl border-2 transition-all duration-200 relative cursor-pointer ${status.scheduled ? (isSelected ? 'bg-red-50 border-red-900 ring-1 ring-red-900 shadow-md' : 'bg-white border-red-200 shadow-sm') : (isSelected ? 'bg-red-50 border-red-900 ring-1 ring-red-900 shadow-md z-10' : 'bg-white border-gray-100 hover:border-red-200 hover:shadow-sm')}`}
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="w-full">
                                                    <div className="flex justify-between items-start">
                                                        <div className="font-bold text-sm text-gray-800 leading-tight">{store.name}</div>
                                                        {store.city && <span className="text-xs font-medium bg-red-100 text-red-900 px-1.5 py-0.5 rounded-md ml-2 h-fit whitespace-nowrap">{store.city}</span>}
                                                    </div>
                                                    <div className="flex items-center gap-2 text-xs text-gray-500 mt-2 mb-3"><User size={14} />{store.coordinator}</div>
                                                    {!isSelected && isHovered && store.stats && (
                                                        <div className="absolute left-full top-0 ml-4 z-50 w-64 bg-slate-800 text-white p-4 rounded-xl shadow-2xl text-sm animate-in fade-in slide-in-from-left-2 pointer-events-none">
                                                            <div className="font-bold text-red-400 mb-3 border-b border-slate-700 pb-2 uppercase tracking-wider text-base">Indicadores</div>
                                                            <div className="space-y-3">
                                                                <div className="flex justify-between items-center"><span className="text-slate-400 flex items-center gap-2"><History size={14}/> Último Balanço:</span><span className="font-mono text-base">{store.stats.lastBalance}</span></div>
                                                                <div className="flex justify-between items-center"><span className="text-slate-400 flex items-center gap-2"><TrendingUp size={14}/> Acuracidade:</span><span className={`font-mono font-bold text-base ${parseFloat(store.stats.accuracy) > 99 ? 'text-green-400' : 'text-yellow-400'}`}>{store.stats.accuracy}</span></div>
                                                            </div>
                                                            <div className="absolute top-6 -left-2 w-4 h-4 bg-slate-800 rotate-45"></div>
                                                        </div>
                                                    )}
                                                    {(isSelected) && (
                                                        <div className="space-y-4 mt-3">
                                                            {store.stats ? (
                                                                <div className="bg-white/60 rounded-lg p-3 border border-red-200 text-sm text-gray-700">
                                                                    <div className="flex justify-between mb-2"><span>Último Balanço:</span><span className="font-semibold">{store.stats.lastBalance}</span></div>
                                                                    <div className="flex justify-between"><span>Acuracidade:</span><span className={`font-bold ${parseFloat(store.stats.accuracy) > 99 ? 'text-green-600' : 'text-orange-500'}`}>{store.stats.accuracy}</span></div>
                                                                </div>
                                                            ) : (
                                                                <div className="bg-orange-50 rounded-lg p-3 border border-orange-100 text-sm text-orange-700 flex items-center gap-2"><AlertTriangle size={16} /><span>Sem dados de balanço.</span></div>
                                                            )}
                                                            {nearbyStores.length > 0 && (
                                                                <div className="bg-slate-50 rounded-xl p-3 border border-slate-200">
                                                                    <div className="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase mb-3"><Route size={14} />Próximas (até 400km)</div>
                                                                    <div className="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                                                                        {nearbyStores.map(ns => {
                                                                            const nsStatus = getStoreStatus(ns.id);
                                                                            return (
                                                                                <div key={ns.id} className="flex justify-between items-center text-sm p-2 bg-white rounded-lg border border-slate-100 shadow-sm">
                                                                                    <div className="truncate flex-1"><div className="font-bold text-slate-700 truncate">{ns.name.replace('LOJA ', '')}</div><div className="text-slate-400 text-xs">{Math.round(ns.distance)} km</div></div>
                                                                                    {nsStatus.scheduled ? <div className="w-3 h-3 rounded-full bg-red-600 shadow-sm" title="Já agendado"></div> : <div className="w-3 h-3 rounded-full border-2 border-slate-300" title="Pendente"></div>}
                                                                                </div>
                                                                            )
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            <div className="pt-4 border-t border-red-200 animate-in fade-in zoom-in duration-200">
                                                                <span className="text-xs text-red-900 font-bold uppercase tracking-wider block mb-3">{status.scheduled ? "Editando Agendamento:" : "Selecione o Transporte:"}</span>
                                                                <div className="flex gap-3 mb-4" onClick={(e) => e.stopPropagation()}>
                                                                    <button onClick={() => updateTransport(store.id, 'car')} className={`flex-1 flex flex-col items-center justify-center p-3 rounded-lg transition-all text-sm font-medium border ${selectedTransport === 'car' ? 'bg-red-800 text-white border-red-800 shadow-md' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}><Car size={20} className="mb-1" />Carro</button>
                                                                    <button onClick={() => updateTransport(store.id, 'bus')} className={`flex-1 flex flex-col items-center justify-center p-3 rounded-lg transition-all text-sm font-medium border ${selectedTransport === 'bus' ? 'bg-red-800 text-white border-red-800 shadow-md' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}><Bus size={20} className="mb-1" />Ônibus</button>
                                                                    <button onClick={() => updateTransport(store.id, 'plane')} className={`flex-1 flex flex-col items-center justify-center p-3 rounded-lg transition-all text-sm font-medium border ${selectedTransport === 'plane' ? 'bg-red-800 text-white border-red-800 shadow-md' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}><Plane size={20} className="mb-1" />Avião</button>
                                                                </div>
                                                                {status.scheduled ? (
                                                                    <button onClick={(e) => { e.stopPropagation(); removeAssignment(store.id); }} className="w-full flex items-center justify-center gap-2 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 p-3 rounded-lg text-sm font-bold transition-colors"><Trash2 size={18} />Remover Agendamento</button>
                                                                ) : (<div className="text-xs text-center text-red-500 italic font-medium">Agora clique na data no calendário →</div>)}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                                {status.scheduled ? <CheckCircle2 size={24} className="text-red-900 shrink-0 ml-2" /> : !isSelected ? <div className="w-5 h-5 rounded-full border-2 border-gray-300 shrink-0 ml-2"></div> : null}
                                            </div>
                                            {status.scheduled && <div className="text-sm font-bold text-white mt-2 bg-red-900 inline-block px-3 py-1 rounded-md flex items-center gap-2 shadow-sm"><Check size={14} strokeWidth={3} /><span>Agendado: {status.date?.split('-').reverse().join('/')}</span></div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </aside>

                        <main className="flex-1 flex flex-col h-full bg-gray-100 p-4 md:p-6 overflow-hidden">
                            <div className="flex items-center justify-between mb-4 bg-white p-4 rounded-xl shadow-sm shrink-0 gap-4">
                                <div className="flex items-center gap-3">
                                    <button onClick={prevMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronLeft className="text-gray-600" size={28} /></button>
                                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3"><CalendarIcon className="text-red-800" size={32} /><span className="whitespace-nowrap">{monthNames[month]} <span className="text-gray-400 font-light">{year}</span></span></h2>
                                    <button onClick={nextMonth} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><ChevronRight className="text-gray-600" size={28} /></button>
                                </div>
                                
                                <div className="flex-1 overflow-hidden relative mx-4 h-12 flex items-center bg-white rounded-lg px-2 border border-gray-200">
                                    {tickerGroups.length > 0 && (
                                        <div key={currentTickerIndex} className="w-full animate-fade-in-slide flex items-center gap-2 overflow-hidden">
                                            <span className="text-red-900 font-bold uppercase whitespace-nowrap px-2 py-1 bg-red-50 rounded-md text-xs border border-red-100">
                                                {monthNames[tickerGroups[currentTickerIndex].month]}
                                            </span>
                                            <div className="flex items-center gap-3 overflow-x-auto custom-scrollbar pb-1">
                                                {tickerGroups[currentTickerIndex].items.map((assign, idx) => {
                                                     const store = stores.find(s => s.id === assign.storeId);
                                                     if (!store) return null;
                                                     
                                                     const assignDate = new Date(assign.dateStr + 'T12:00:00');
                                                     const today = new Date();
                                                     today.setHours(0,0,0,0);
                                                     
                                                     const isPast = assignDate < today;
                                                     const isDone = assign.completed || isPast;
                                                     const colorClass = isDone ? 'text-green-800' : 'text-red-700';
                                                     
                                                     return (
                                                         <span key={idx} className={`text-sm font-bold ${colorClass} whitespace-nowrap flex items-center gap-1`}>
                                                             {store.name.replace('LOJA ', '')} <span className="text-xs text-gray-400 font-normal">({formatDayOnly(assign.dateStr)})</span>
                                                             {idx < tickerGroups[currentTickerIndex].items.length - 1 && <span className="text-gray-300 mx-1">•</span>}
                                                         </span>
                                                     );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                    {tickerGroups.length === 0 && <span className="text-gray-400 text-sm italic w-full text-center">Nenhum agendamento encontrado.</span>}
                                </div>

                                {selectedStoreId && <div className="hidden md:flex items-center gap-3 text-sm bg-red-50 text-red-800 px-4 py-2 rounded-full border border-red-200 animate-in fade-in shadow-sm"><span className="w-2.5 h-2.5 rounded-full bg-red-800 animate-pulse"></span><span>Editando: <strong>{stores.find(s => s.id === selectedStoreId)?.name}</strong></span></div>}
                            </div>
                            <div className="flex-1 bg-white rounded-xl shadow-sm border border-red-900 overflow-hidden flex flex-col min-h-0">
                                <div className="grid grid-cols-7 bg-white h-full border-t border-l border-gray-300 overflow-y-auto custom-scrollbar content-start">
                                    {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(day => (<div key={day} className="sticky top-0 z-20 py-2 text-center text-sm font-bold text-white bg-red-900 border-r border-b border-gray-300 uppercase tracking-wider">{day}</div>))}
                                    {Array.from({ length: firstDay }).map((_, i) => (<div key={`empty-${i}`} className="bg-gray-50 h-24 md:h-28 border-r border-b border-gray-300 relative group transition-colors hover:bg-gray-100"></div>))}
                                    {Array.from({ length: daysInMonth }).map((_, i) => {
                                        const day = i + 1;
                                        const dateStr = formatDate(year, month, day);
                                        const dayAssignments = assignments.filter(a => a.dateStr === dateStr);
                                        const dayHolidays = HOLIDAYS_2026.filter(h => h.date === dateStr);
                                        
                                        const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                                        const isTarget = !!selectedStoreId;
                                        const isHoliday = dayHolidays.length > 0;
                                        
                                        return (
                                            <div key={day} onClick={() => handleDateClick(day)} className={`relative h-24 md:h-28 flex flex-col gap-1 border-r border-b border-gray-300 transition-colors bg-white ${isTarget ? 'cursor-pointer hover:bg-red-50 ring-inset ring-2 ring-red-800 z-10' : ''} ${isToday ? 'bg-red-50' : ''}`}>
                                                <div className="flex justify-between items-start p-1 shrink-0">
                                                    <span className={`text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-red-800 text-white shadow-md' : isHoliday ? 'bg-blue-100 text-blue-800' : 'text-black'}`}>{day}</span>
                                                </div>
                                                <div className="flex-1 flex flex-col gap-1 w-full overflow-y-auto custom-scrollbar px-1 pb-1">
                                                    {dayHolidays.map((hol, idx) => (
                                                        <div key={`hol-${idx}`} className="shrink-0 text-[10px] p-1 rounded border shadow-sm bg-blue-50 text-blue-800 border-blue-200 mb-1 flex flex-col items-center text-center leading-tight w-full" title={hol.name}>
                                                            <span className="font-bold w-full break-words line-clamp-2">{hol.name}</span>
                                                            <span className="text-[8px] uppercase opacity-70 mt-0.5">{hol.type}</span>
                                                        </div>
                                                    ))}
                                                    {dayAssignments.map((assign, idx) => {
                                                        const store = filteredStores.find(s => s.id === assign.storeId);
                                                        if (!store) return null;
                                                        const isAssignSelected = selectedStoreId === store.id;
                                                        const isCompleted = assign.completed;
                                                        return (
                                                            <div key={idx} onClick={(e) => { e.stopPropagation(); setSelectedStoreId(store.id); setSelectedTransport(assign.transport); }} title={`Coordenadora: ${store.coordinator} | Transporte: ${getTransportLabel(assign.transport)}\nBalanço: ${store.stats?.lastBalance || '-'}`} className={`shrink-0 text-[9px] p-1 rounded border shadow-sm relative group cursor-pointer transition-all flex flex-col items-center text-center leading-tight w-full ${isCompleted ? 'bg-green-700 text-white border-green-800 ring-1 ring-green-600' : `bg-pink-200 text-pink-900 border-pink-300 ${isAssignSelected ? 'ring-2 ring-red-800 shadow-lg scale-105 z-10' : 'hover:scale-105 hover:shadow-md'}`}`}>
                                                                <span className="font-bold w-full break-words line-clamp-2">{store.name.replace('LOJA ', '')}</span>
                                                                <span className={`mt-0.5 opacity-90 ${isCompleted ? 'text-green-200' : 'text-pink-800'}`}>{getTransportIcon(assign.transport || 'car', 10)}</span>
                                                                <div className="absolute top-0 right-0 flex opacity-0 group-hover:opacity-100 transition-opacity bg-white/95 rounded-bl-lg shadow-sm border-l border-b border-gray-200">
                                                                    <button onClick={(e) => { e.stopPropagation(); toggleCompletion(store.id); }} className={`p-1 hover:bg-green-100 rounded-bl-lg ${isCompleted ? 'text-green-600' : 'text-gray-400 hover:text-green-600'}`} title={isCompleted ? "Desmarcar" : "Marcar como Concluído"}><Check size={10} strokeWidth={3} /></button>
                                                                    <button onClick={(e) => { e.stopPropagation(); removeAssignment(store.id); }} className="p-1 text-red-400 hover:text-red-600 hover:bg-red-50" title="Remover"><X size={10} /></button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
